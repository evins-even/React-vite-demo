# éƒ¨ç½²é…ç½®æŒ‡å—ï¼šç«¯å£è½¬å‘å’Œè·¨åŸŸè§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

å½“å‰é¡¹ç›®å­˜åœ¨çš„é—®é¢˜ï¼š
- API åœ°å€ç¡¬ç¼–ç ï¼š`http://localhost:3000/api`
- å¼€å‘ç¯å¢ƒï¼šå‰ç«¯ 3001 ç«¯å£ï¼Œåç«¯ 3000 ç«¯å£ï¼ˆå­˜åœ¨è·¨åŸŸï¼‰
- ç”Ÿäº§ç¯å¢ƒï¼šéœ€è¦ç»Ÿä¸€ç«¯å£ï¼Œè§£å†³è·¨åŸŸé—®é¢˜

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šç¯å¢ƒå˜é‡ + Nginx åå‘ä»£ç†ï¼ˆæ¨èï¼‰

#### 1.1 é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env.development`ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ï¼š
```bash
# å¼€å‘ç¯å¢ƒé…ç½®
VITE_API_BASE_URL=http://localhost:3000/api
```

åˆ›å»º `.env.production`ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š
```bash
# ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œé€šè¿‡ Nginx ä»£ç†ï¼‰
VITE_API_BASE_URL=/api
```

#### 1.2 ä¿®æ”¹ä»£ç ä½¿ç”¨ç¯å¢ƒå˜é‡

ä¿®æ”¹ `src/common/utils/commonFetch.ts`ï¼š

```typescript
// ä»ç¯å¢ƒå˜é‡è·å– API åœ°å€
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3000/api';

const api = new FetchInterceptor(
    API_BASE_URL,
    10000
);
```

#### 1.3 Nginx é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

åˆ›å»º `nginx.conf`ï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºä½ çš„åŸŸå
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    root /var/www/my-react-demo/dist;
    index index.html;
    
    # å‰ç«¯è·¯ç”±ï¼ˆSPAï¼‰
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API ä»£ç†ï¼ˆè§£å†³è·¨åŸŸå’Œç«¯å£è½¬å‘ï¼‰
    location /api {
        proxy_pass http://localhost:3000/api;  # åç«¯æœåŠ¡åœ°å€
        proxy_http_version 1.1;
        
        # è¯·æ±‚å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è·¨åŸŸè®¾ç½®ï¼ˆå¦‚æœåç«¯æ²¡æœ‰è®¾ç½® CORSï¼‰
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
        add_header Access-Control-Allow-Headers 'Authorization, Content-Type';
        
        # å¤„ç†é¢„æ£€è¯·æ±‚
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        # WebSocket æ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼‰
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json;
}
```

#### 1.4 éƒ¨ç½²æ­¥éª¤

```bash
# 1. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# 2. å°† dist ç›®å½•ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp -r dist/* user@server:/var/www/my-react-demo/dist/

# 3. é‡å¯ Nginx
sudo nginx -t  # æ£€æŸ¥é…ç½®
sudo nginx -s reload  # é‡æ–°åŠ è½½é…ç½®
```

---

### æ–¹æ¡ˆ 2ï¼šåç«¯é…ç½® CORSï¼ˆå¦‚æœå‰åç«¯åˆ†ç¦»éƒ¨ç½²ï¼‰

å¦‚æœå‰åç«¯ä¸åœ¨åŒä¸€æœåŠ¡å™¨ï¼Œåç«¯éœ€è¦é…ç½® CORSï¼š

#### 2.1 Node.js/Express åç«¯ç¤ºä¾‹

```javascript
const express = require('express');
const cors = require('cors');

const app = express();

// CORS é…ç½®
app.use(cors({
    origin: [
        'http://localhost:3001',  // å¼€å‘ç¯å¢ƒ
        'https://your-domain.com'  // ç”Ÿäº§ç¯å¢ƒ
    ],
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization']
}));

// æˆ–è€…æ‰‹åŠ¨è®¾ç½®
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', 'https://your-domain.com');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    res.header('Access-Control-Allow-Credentials', 'true');
    
    if (req.method === 'OPTIONS') {
        return res.sendStatus(200);
    }
    next();
});
```

#### 2.2 å‰ç«¯é…ç½®ï¼ˆä½¿ç”¨å®Œæ•´ URLï¼‰

```typescript
// ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å®Œæ•´åç«¯åœ°å€
const API_BASE_URL = import.meta.env.PROD 
    ? 'https://api.your-domain.com/api'  // ç”Ÿäº§ç¯å¢ƒåç«¯åœ°å€
    : 'http://localhost:3000/api';        // å¼€å‘ç¯å¢ƒ

const api = new FetchInterceptor(API_BASE_URL, 10000);
```

---

### æ–¹æ¡ˆ 3ï¼šVite å¼€å‘æœåŠ¡å™¨ä»£ç†ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰

ä¿®æ”¹ `vite.config.js`ï¼š

```javascript
export default defineConfig({
  // ... å…¶ä»–é…ç½®
  
  server: {
    port: 3001,
    open: true,
    // å¼€å‘ç¯å¢ƒä»£ç†ï¼ˆè§£å†³è·¨åŸŸï¼‰
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '/api'),
        // å¦‚æœéœ€è¦ WebSocket
        ws: true,
      }
    }
  },
  
  // ... å…¶ä»–é…ç½®
});
```

ç„¶åä¿®æ”¹ `commonFetch.ts`ï¼š

```typescript
// å¼€å‘ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆé€šè¿‡ Vite ä»£ç†ï¼‰
// ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®çš„åœ°å€
const API_BASE_URL = import.meta.env.DEV 
    ? '/api'  // å¼€å‘ç¯å¢ƒï¼šé€šè¿‡ Vite ä»£ç†
    : import.meta.env.VITE_API_BASE_URL || '/api';  // ç”Ÿäº§ç¯å¢ƒï¼šé€šè¿‡ Nginx ä»£ç†

const api = new FetchInterceptor(API_BASE_URL, 10000);
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| **æ–¹æ¡ˆ1ï¼šNginx åå‘ä»£ç†** | å‰åç«¯åŒæœåŠ¡å™¨ | âœ… ç»Ÿä¸€ç«¯å£<br>âœ… è§£å†³è·¨åŸŸ<br>âœ… æ€§èƒ½å¥½ | âš ï¸ éœ€è¦ Nginx |
| **æ–¹æ¡ˆ2ï¼šåç«¯ CORS** | å‰åç«¯åˆ†ç¦»éƒ¨ç½² | âœ… é…ç½®ç®€å•<br>âœ… çµæ´» | âš ï¸ éœ€è¦åç«¯é…åˆ<br>âš ï¸ å®‰å…¨æ€§éœ€æ³¨æ„ |
| **æ–¹æ¡ˆ3ï¼šVite ä»£ç†** | ä»…å¼€å‘ç¯å¢ƒ | âœ… å¼€å‘æ–¹ä¾¿ | âŒ ä»…å¼€å‘ç¯å¢ƒæœ‰æ•ˆ |

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

**ç”Ÿäº§ç¯å¢ƒï¼šæ–¹æ¡ˆ 1ï¼ˆNginx åå‘ä»£ç†ï¼‰**
- âœ… ç»Ÿä¸€ç«¯å£ï¼ˆ80/443ï¼‰
- âœ… è§£å†³è·¨åŸŸ
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ã€å‹ç¼©ï¼‰
- âœ… å®‰å…¨æ€§å¥½

**å¼€å‘ç¯å¢ƒï¼šæ–¹æ¡ˆ 3ï¼ˆVite ä»£ç†ï¼‰**
- âœ… é…ç½®ç®€å•
- âœ… çƒ­æ›´æ–°æ”¯æŒ
- âœ… å¼€å‘ä½“éªŒå¥½

---

## ğŸ“ å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šä¿®æ”¹ä»£ç ä½¿ç”¨ç¯å¢ƒå˜é‡

ä¿®æ”¹ `src/common/utils/commonFetch.ts`ï¼š

```typescript
// è·å–ç¯å¢ƒå˜é‡
const getApiBaseUrl = () => {
  // å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨ Vite ä»£ç†ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
  if (import.meta.env.DEV) {
    return '/api';
  }
  
  // ç”Ÿäº§ç¯å¢ƒï¼šä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œæˆ–ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆé€šè¿‡ Nginx ä»£ç†ï¼‰
  return import.meta.env.VITE_API_BASE_URL || '/api';
};

const api = new FetchInterceptor(
    getApiBaseUrl(),
    10000
);
```

### æ­¥éª¤ 2ï¼šåˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶

`.env.development`ï¼š
```bash
VITE_API_BASE_URL=/api
```

`.env.production`ï¼š
```bash
VITE_API_BASE_URL=/api
```

### æ­¥éª¤ 3ï¼šé…ç½® Nginxï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

ä½¿ç”¨ä¸Šé¢çš„ `nginx.conf` é…ç½®

### æ­¥éª¤ 4ï¼šé…ç½® Vite ä»£ç†ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

åœ¨ `vite.config.js` ä¸­æ·»åŠ  `server.proxy` é…ç½®

---

## âœ… éªŒè¯

### å¼€å‘ç¯å¢ƒéªŒè¯ï¼š
```bash
npm run dev
# è®¿é—® http://localhost:3001
# API è¯·æ±‚ä¼šè‡ªåŠ¨ä»£ç†åˆ° http://localhost:3000/api
```

### ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼š
```bash
npm run build
# éƒ¨ç½²åˆ°æœåŠ¡å™¨å
# è®¿é—® http://your-domain.com
# API è¯·æ±‚ä¼šé€šè¿‡ Nginx ä»£ç†åˆ°åç«¯
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒä¸è¦ä½¿ç”¨é€šé…ç¬¦ CORS**ï¼š
   ```nginx
   # âŒ ä¸å®‰å…¨
   add_header Access-Control-Allow-Origin *;
   
   # âœ… å®‰å…¨
   add_header Access-Control-Allow-Origin https://your-domain.com;
   ```

2. **ä½¿ç”¨ HTTPS**ï¼š
   ```nginx
   server {
       listen 443 ssl;
       ssl_certificate /path/to/cert.pem;
       ssl_certificate_key /path/to/key.pem;
       # ...
   }
   ```

3. **é™åˆ¶ API è®¿é—®**ï¼š
   ```nginx
   # åªå…è®¸ç‰¹å®š IP è®¿é—®åç«¯
   location /api {
       allow 192.168.1.0/24;
       deny all;
       # ...
   }
   ```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Vite ç¯å¢ƒå˜é‡](https://vitejs.dev/guide/env-and-mode.html)
- [Nginx åå‘ä»£ç†](https://nginx.org/en/docs/http/ngx_http_proxy_module.html)
- [CORS è¯¦è§£](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS)

